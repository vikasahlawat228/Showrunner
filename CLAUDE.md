# Showrunner — Development Guide

CLI tool for creating manga/manhwa/comic panels with agentic AI workflows.

## Quick Start

```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -e .
showrunner --help
showrunner server start
```

## Architecture

- **Package**: `src/showrunner_tool/` (named `showrunner_tool` to avoid Python stdlib `showrunner` Easter egg collision)
- **CLI entry point**: `showrunner = showrunner_tool.cli:app` (Typer)
- **Schemas**: Pydantic v2 models in `schemas/` — all serialized as YAML
- **Core logic**: `core/` — project, context compiler, creative room, template engine, workflow, evaluator, briefing, session manager
- **Commands**: `commands/` — one file per command group (world, character, story, scene, screenplay, panel, brief, decide, session, etc.)
- **Templates**: `prompts/` — Jinja2 `.md.j2` templates for LLM prompt assembly
- **Knowledge Base**: `knowledge/` — markdown articles on fiction writing, panel composition, image prompts

## Web Studio Development

The project now includes a Next.js frontend in `src/web/`.

### Run Development Server
1. **Backend**: `showrunner server start --reload` (Port 8000)
2. **Frontend**: `cd src/web && npm run dev` (Port 3000)

### Frontend Architecture
- **Framework**: Next.js 14 (App Router)
- **Styling**: Tailwind CSS
- **Drag & Drop**: @dnd-kit
- **State**: Zustand

## Key Design Decisions

1. **Agent-first architecture**: Claude Code is the Director Agent. It runs `showrunner` commands to compile context, generates content itself (free), and only uses Gemini API for image generation.
2. **Context isolation**: `creative_room/` data (plot twists, secrets) is NEVER included in story-level prompts. Only `evaluate` commands use author-level access.
3. **Positive-list filtering**: Reader knowledge is tracked via `ReaderKnowledgeState` — prompts only include what the reader knows, rather than trying to block secrets.
4. **Character DNA blocks**: Stable identity tokens for consistent image generation across panels.
5. **Manhwa/webtoon primary**: Vertical scroll, 9:16 aspect ratio, 1-2 panels per screen section.
6. **Cross-session persistence**: Decisions, session logs, and dynamic CLAUDE.md briefings carry context between ephemeral agent sessions.

## Cross-Session System

Stories span many sessions. The persistence layer handles this:

- **Decision Log** (`.showrunner/decisions.yaml`): Author preferences that persist across sessions. Scoped to global, chapter, scene, or character. Auto-injected into context compilation.
- **Session Log** (`.showrunner/sessions/`): What happened in each working session — summary, actions, next steps.
- **Dynamic CLAUDE.md**: The per-project CLAUDE.md has a `<!-- DYNAMIC:START -->` section that gets regenerated by `showrunner brief update` with current state.
- **Briefing Generator** (`core/briefing.py`): Scans project state and produces a compact ProjectBrief that new sessions can load instantly.

### Key files:
- `schemas/session.py` — Decision, SessionEntry, ProjectBrief schemas
- `core/session_manager.py` — DecisionLog, SessionLog persistence
- `core/briefing.py` — BriefingGenerator, dynamic CLAUDE.md rendering
- `commands/brief.py` — `showrunner brief show|update|context`
- `commands/decide.py` — `showrunner decide add|list|remove`
- `commands/session_cmd.py` — `showrunner session start|end|history`

## Cost Model

- **Claude Code (free)**: Orchestration, reasoning, content generation, evaluation, file management
- **Gemini API (paid, via GEMINI_API_KEY)**: Image generation only (Imagen 4)
- **Context compilation**: Local Python, no API calls
- The `showrunner` CLI prints prompts to stdout — Claude Code reads these and generates YAML directly

## Testing

```bash
# Create a test project
cd /tmp && showrunner init "Test" --template manhwa --structure save_the_cat
cd test
showrunner status
showrunner brief show
showrunner world build
showrunner character create "Hero" --role protagonist
showrunner decide add "Dark fantasy tone" --category tone
showrunner decide list
showrunner story outline --structure kishotenketsu
showrunner session end "Built world and characters" --next "Write first scene"
```

## File Conventions

- Schemas use `ShowrunnerBase` (ULID ids, timestamps, schema_version)
- YAML I/O via `utils/io.py` (read_yaml, write_yaml)
- Rich console output via `utils/display.py`
- Template overrides: user project `prompts/` dir takes priority over built-in `prompts/`
- Per-project CLAUDE.md has static instructions + dynamic state between `<!-- DYNAMIC:START -->` and `<!-- DYNAMIC:END -->` markers
